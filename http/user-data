#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  
  keyboard:
    layout: us

  # 'interactive-sections' controls if the installer stops to ask questions.
  # Set to [] (empty list) for fully automated.
  interactive-sections: []

  ssh:
    install-server: true
    allow-pw: true

  identity:
    hostname: ubuntu24-golden
    username: ubuntu
    # Password: "ubuntu" (example hash)
    password: "$6$gXvGGLYtBfU1cvyO$pRaGMuhKRB1XUQKszal3NbVoIJhf6UBSP482005KLbvlkXiVEMGp9eiqV78E3R5gCqxDv1kzraD3q86kfeDIE/"

  storage:
    layout:
      name: lvm

  packages:
    - qemu-guest-agent
    # Removed: sudo, cloud-init, openssh-server (these are installed by default)

  late-commands:
    # 1. SSH Configuration (Create a priority override file)
    - curtin in-target --target=/target -- sh -c "echo 'PermitRootLogin yes' > /etc/ssh/sshd_config.d/99-root-login.conf"
    - curtin in-target --target=/target -- sh -c "echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config.d/99-root-login.conf"
    - curtin in-target --target=/target -- chmod 644 /etc/ssh/sshd_config.d/99-root-login.conf

    # 2. Unlock Root Account (CRITICAL STEP)
    # -U unlocks the account, -s ensures they have a login shell
    - curtin in-target --target=/target -- usermod -U root
    - curtin in-target --target=/target -- usermod -s /bin/bash root

    # 3. Set Root Password
    # usage of chpasswd is correct, but we ensure it runs in a clean shell environment
    - curtin in-target --target=/target -- sh -c "echo 'root:anilankem' | chpasswd"

    # 4. Enable QEMU Agent
    - curtin in-target --target=/target -- systemctl enable qemu-guest-agent

    # 5. cloud init config for root login via ssh password
    - curtin in-target --target=/target -- sh -c "echo 'disable_root: false' >> /etc/cloud/cloud.cfg"
    - curtin in-target --target=/target -- sh -c "echo 'ssh_pwauth: true' >> /etc/cloud/cloud.cfg"