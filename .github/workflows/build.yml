name: Build Rocky 9 Golden Image

on:
  workflow_dispatch:

env:
  VMID: "9002"
  NODE: "proxmox"

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ✅ Cleanup old VM if exists
      - name: Cleanup existing VM
        run: |
          STATUS=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.status' 2>/dev/null || echo "notfound")

          if [ "$STATUS" != "notfound" ] && [ "$STATUS" != "null" ]; then
            echo "VM exists. Removing..."
            curl -s -k -X POST \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
              ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/stop || true
            sleep 8
            curl -s -k -X DELETE \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
              ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}
          fi

      - name: Packer Init
        run: packer init rocky.pkr.hcl

      - name: Packer Validate
        env:
          PKR_VAR_proxmox_url: ${{ secrets.PROXMOX_URL }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: packer validate rocky.pkr.hcl

      - name: Packer Build
        env:
          PKR_VAR_proxmox_url: ${{ secrets.PROXMOX_URL }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: packer build rocky.pkr.hcl

      # ✅ Verify VM stopped
      - name: Verify VM stopped
        run: |
          STATE=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.status')

          [ "$STATE" = "stopped" ]

      # ✅ Convert to template
      - name: Convert to Template
        run: |
          curl -s -k -X POST \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/template

      # ✅ Validate template
      - name: Validate Template
        run: |
          TEMPLATE=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.template')

          [ "$TEMPLATE" = "true" ]
